name: Backend CI / Integration Tests

on:
  pull_request:
    branches: ['main']

permissions:
  contents: read

jobs:
  test_backend:
    runs-on: ubuntu-latest

    container: python:3.11-slim

    # Startet die Datenbank und MinIO als Services f체r Integrationstests
    services:
      db:
        image: postgres:15-alpine
        # Wichtig: Diese Credentials m체ssen in Ihren Tests verwendet werden
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: social_media_db
        # Stellt sicher, dass die Datenbank bereit ist, bevor die Schritte beginnen
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 1. Code abrufen
        uses: actions/checkout@v4

      # Alle weiteren Schritte laufen nun INNEN des 'python:3.11-slim' Containers.

      - name: 2. Create venv and Install Dependencies
        working-directory: ./be/
        run: |
          # 2.1 Erstellt die virtuelle Umgebung im Unterordner
          python -m venv .venv 
          # 2.2 Installiert Abh채ngigkeiten, Pytest und Flake8
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt
          .venv/bin/pip install pytest flake8  # Stellen Sie sicher, dass diese Tools installiert werden

      - name: 3. Warte auf Datenbank-Bereitschaft
        working-directory: ./be/
        run: |
          # Ein kurzer Sleep kann helfen, der DB Zeit zum Starten zu geben (oder 'wait-for-it.sh' nutzen)
          sleep 10

      - name: 4. Lint mit Flake8
        working-directory: ./be/
        run: |
          .venv/bin/flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: 5. Test with pytest (Unit & Integration)
        working-directory: ./be/
        env:
          # Exponiert die Umgebungsvariablen f체r die Backend-Tests
          # Der Hostname ist der Service-Name (db, minio)
          POSTGRES_HOST: db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
          MINIO_ENDPOINT: minio:9000
          MINIO_ACCESS_KEY: test_minio_user
          MINIO_SECRET_KEY: test_minio_password
        run: |
          .venv/bin/pytest
